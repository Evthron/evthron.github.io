(()=>{var m={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","\u2026":"&hellip;"};function T(h){return m[h]||h}function p(h){return h.replace(/[&<>"]/g,T)}function f(h){return h.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}var d=class h{data;form;input;tags;list;resultTitle;resultTitleTemplate;constructor({form:t,input:r,tags:a,list:n,resultTitle:e,resultTitleTemplate:s}){this.form=t,this.input=r,this.list=n,this.tags=a,this.resultTitle=e,this.resultTitleTemplate=s,this.handleQueryString(),this.bindQueryStringChange(),this.bindSearchForm()}static processMatches(t,r,a=!0,n=140,e=20){r.sort((l,o)=>l.start-o.start);let s=0,i=0,c=0,u=[];for(;s<r.length;){let l=r[s];a&&l.start-e>i?(u.push(`${p(t.substring(i,i+e))} [...] `),u.push(`${p(t.substring(l.start-e,l.start))}`),c+=e*2):(u.push(p(t.substring(i,l.start))),c+=l.start-i);let o=s+1,g=l.end;for(;o<r.length&&r[o].start<=g;)g=Math.max(r[o].end,g),++o;if(u.push(`<mark>${p(t.substring(l.start,g))}</mark>`),c+=g-l.start,s=o,i=g,a&&c>n)break}if(i<t.length){let l=t.length;a&&(l=Math.min(l,i+e)),u.push(`${p(t.substring(i,l))}`),a&&l!=t.length&&u.push(" [...]")}return u.join("")}async searchKeywords(t){let r=await this.getData(),a=[],n=new RegExp(t.filter((e,s,i)=>(i[s]=f(e),e.trim()!=="")).join("|"),"gi");for(let e of r){let s=[],i=[],c={...e,preview:"",matchCount:0},u=e.content.matchAll(n);for(let o of Array.from(u))i.push({start:o.index,end:o.index+o[0].length});let l=e.title.matchAll(n);for(let o of Array.from(l))s.push({start:o.index,end:o.index+o[0].length});s.length>0&&(c.title=h.processMatches(c.title,s,!1)),i.length>0?c.preview=h.processMatches(c.content,i):c.preview=p(c.content.substring(0,140)),c.matchCount=s.length+i.length,c.matchCount>0&&a.push(c)}return a.sort((e,s)=>s.matchCount-e.matchCount)}async doSearch(t,r){let a=performance.now(),n=await this.searchKeywords(t);t?.length||(n=await this.getData());let e=n.filter(i=>r?.every(c=>i.tags?.includes(c)));this.clear();for(let i of e)this.list.append(h.render(i));let s=performance.now();this.resultTitle.innerText=this.generateResultTitle(e.length,((s-a)/1e3).toPrecision(1))}generateResultTitle(t,r){return this.resultTitleTemplate.replace("#PAGES_COUNT",t).replace("#TIME_SECONDS",r)}async getData(){if(!this.data){let t=this.form.dataset.json;this.data=await fetch(t).then(a=>a.json());let r=new DOMParser;for(let a of this.data)a.content=r.parseFromString(a.content,"text/html").body.innerText}return this.data}bindSearchForm(){let t="",r=[],a=n=>{n.preventDefault();let e=this.input.value.trim(),s=this.tags.searchTags;if(h.updateQueryString(e,s,!0),e===""&&!s?.length)return t="",this.clear();t===e&&s===r||(t=e,this.doSearch(e.split(" "),s))};this.input.addEventListener("input",a),this.input.addEventListener("compositionend",a),this.tags.addEventListener("click",n=>{n.target.classList.contains("tag-button")&&a.call(this,n)})}clear(){this.list.innerHTML="",this.resultTitle.innerText=""}bindQueryStringChange(){window.addEventListener("popstate",t=>{this.handleQueryString()})}handleQueryString(){let t=new URL(window.location.toString()),r=t.searchParams.get("keyword"),a=t.searchParams.getAll("tag");this.input.value=r,r?this.doSearch(r.split(" "),a):this.clear()}static updateQueryString(t,r,a=!1){let n=new URL(window.location.toString());t===""?n.searchParams.delete("keyword"):n.searchParams.set("keyword",t),n.searchParams.delete("tag"),r?.length&&r.forEach(e=>{n.searchParams.append("tag",e)}),a?window.history.replaceState("","",n.toString()):window.history.pushState("","",n.toString())}static render(t){return createElement("article",null,createElement("a",{href:t.permalink},createElement("div",{class:"article-details"},createElement("h2",{class:"article-title",dangerouslySetInnerHTML:{__html:t.title}}),createElement("section",{class:"article-preview",dangerouslySetInnerHTML:{__html:t.preview}})),t.image&&createElement("div",{class:"article-image"},createElement("img",{src:t.image,loading:"lazy"}))))}};window.addEventListener("load",()=>{setTimeout(function(){let h=document.querySelector(".search-form"),t=h.querySelector("input"),r=document.querySelector(".tagSearch-tags"),a=document.querySelector(".search-result--list"),n=document.querySelector(".search-result--title");new d({form:h,input:t,list:a,tags:r,resultTitle:n,resultTitleTemplate:window.searchResultTitleTemplate})},0)});var w=d;})();
